<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>トモシカ対局棋譜データ</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; color: #333; padding: 2em; }
    select, button, textarea { font-size: 1em; margin-top: 1em; width: 100%; }
    .meta { margin-top: 1em; }
  </style>
</head>
<body>
  <h1>トモシカ対局棋譜データ</h1>
  <select id="matchSelect"></select>
  <div class="meta" id="matchMeta"></div>
  <textarea id="kifArea" rows="15" readonly></textarea>
  <a id="downloadBtn" download style="display:none;">棋譜をダウンロード</a>
  <p>このサイトについての問い合わせは <a href="https://x.com/mega_ebi">@mega_ebi</a> まで</p>

  <script>
    const csvUrl = "https://drive.google.com/uc?id=1Lg1xB79PYue1D5qSPy2IMo6zNMjOgEa4&export=download";
    let matchData = [];

    function extractFileId(url) {
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      return match ? match[1] : null;
    }

    async function loadCSV() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows.shift();
      matchData = rows.map(r => Object.fromEntries(r.map((val, i) => [headers[i], val])));
      updateMatchSelect();
    }

    function updateMatchSelect() {
      const select = document.getElementById("matchSelect");
      matchData.forEach((row, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${row["日付"]} ${row["試合番号"]}局目 ${row["先手"]} 対 ${row["後手"]} (${row["結果"]})`;
        select.appendChild(option);
      });
      select.addEventListener("change", onMatchSelect);
      onMatchSelect();
    }

    async function onMatchSelect() {
      const i = document.getElementById("matchSelect").value;
      const row = matchData[i];
      document.getElementById("matchMeta").innerHTML = `
        <ul>
          <li>日付: ${row["日付"]} - ${row["試合番号"]}局目</li>
          <li>先手: ${row["先手"]}</li>
          <li>後手: ${row["後手"]}</li>
          <li>結果: ${row["結果"]}</li>
          <li>動画: <a href="${row["動画URL"]}" target="_blank">こちらのリンク</a></li>
        </ul>
      `;

      const fileId = extractFileId(row["棋譜データURL"]);
      try {
        const kifRes = await fetch(`https://drive.google.com/uc?id=${fileId}&export=download`);
        const kifText = await kifRes.text();
        document.getElementById("kifArea").value = kifText;
        const blob = new Blob([kifText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.getElementById("downloadBtn");
        a.href = url;
        a.download = `${row["日付"]}_${row["試合番号"]}局目_${row["先手"]}_vs_${row["後手"]}.txt`;
        a.textContent = "棋譜をダウンロード";
        a.style.display = "inline-block";
      } catch (e) {
        document.getElementById("kifArea").value = "棋譜の取得に失敗しました。";
        document.getElementById("downloadBtn").style.display = "none";
      }
    }

    loadCSV();
  </script>
</body>
</html>
